@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject ILocalStorageService LocalStorage
@inject CustomAuthStateProvider AuthStateProvider

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

@if (isUser)
{
    <MudLayout>

        <!-- APP BAR ONLY -->
        <MudAppBar Elevation="4" Class="bg-[#1C1212] text-white">

            <MudText Typo="Typo.h6" Class="ml-3 font-bold">
                Power Gym
            </MudText>

            <MudSpacer />

            <MudButton Variant="Variant.Outlined"
                       Color="Color.Warning"
                       Size="Size.Small"
                       OnClick="@Logout">
                Logout
            </MudButton>
        </MudAppBar>

        <!-- MAIN CONTENT -->
        <MudMainContent>
            @Body
        </MudMainContent>

    </MudLayout>
}

@code {
    private bool isUser;
    private string? fullName;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        fullName = user.FindFirst("FullName")?.Value ?? "User";
        isUser = user.IsInRole("User");
    }

    private async Task Logout()
    {
        await AuthStateProvider.MarkUserAsLoggedOutAsync();
        Navigation.NavigateTo("/", true);
    }
}

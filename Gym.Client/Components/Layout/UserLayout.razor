@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject ILocalStorageService LocalStorage
@inject CustomAuthStateProvider AuthStateProvider

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />
@if (!_initialized)
{
    <div class="loader-container">
        <div class="loader">
            <div class="lightsaber ls-left ls-red"></div>
            <div class="lightsaber ls-right ls-green"></div>
            <div class="ls-particles ls-part-1"></div>
            <div class="ls-particles ls-part-2"></div>
            <div class="ls-particles ls-part-3"></div>
            <div class="ls-particles ls-part-4"></div>
            <div class="ls-particles ls-part-5"></div>
        </div>
    </div>

}
else{
@if (isUser)
{
    <MudLayout>

        <!-- APP BAR ONLY -->
        <MudAppBar Elevation="4" Class="bg-[#1C1212] text-white">

            <MudText Typo="Typo.h6" Class="ml-3 font-bold">
                Power Gym
            </MudText>

            <MudSpacer />

            <MudButton Variant="Variant.Outlined"
                       Color="Color.Warning"
                       Size="Size.Small"
                       OnClick="@Logout">
                Logout
            </MudButton>
        </MudAppBar>

        <!-- MAIN CONTENT -->
        <MudMainContent>
            @Body
        </MudMainContent>

    </MudLayout>

}
    else
    {
        <MudText> YOU ARE NOT AUTHORIZED</MudText>
    }
}

@code {
    private bool isUser;
    private string? fullName;
    private bool _initialized;
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        fullName = user.FindFirst("FullName")?.Value ?? "User";
        isUser = user.IsInRole("User");
        await Task.Delay(5000);
        _initialized = true;
    }

    private async Task Logout()
    {
        await AuthStateProvider.MarkUserAsLoggedOutAsync();
        Navigation.NavigateTo("/", true);
    }
}

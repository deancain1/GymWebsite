﻿<MudDialog>
    <DialogContent>
        <div id="qr-reader" style="width:100%; height:300px;"></div>
        <MudText Typo="Typo.subtitle1">@message</MudText>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }
    [Inject] IJSRuntime JS { get; set; }
    [Inject] HttpClient Http { get; set; }
    [Inject] ISnackbar Snackbar { get; set; }

    private string message = "Scanning...";
    private DotNetObjectReference<ScannerDialog> _objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("qrScanner.init", _objRef);
        }
    }

    [JSInvokable]
    public async Task OnQrScanned(string qrCode)
    {
        if (!int.TryParse(qrCode.Trim().Replace("Member ID:", ""), out int memberId))
        {
            message = "Invalid QR code.";
            StateHasChanged();
            return;
        }

        var scanRequest = new ScanRequestDTO { MemberID = memberId };
        var response = await Http.PostAsJsonAsync("api/Attendance/scan", scanRequest);
        var result = await response.Content.ReadAsStringAsync();

        if (response.IsSuccessStatusCode)
        {
            message = result;
            Snackbar.Add(result, Severity.Success);
        }
        else
        {
            message = result;
           
            if (result.Contains("Expired", StringComparison.OrdinalIgnoreCase))
                Snackbar.Add(result, Severity.Warning);

            else
                Snackbar.Add(result, Severity.Error);
        }

        StateHasChanged();
    }

    private async void Close()
    {
        await JS.InvokeVoidAsync("qrScanner.stop");
        MudDialog.Close();
    }

    public void Dispose() => _objRef?.Dispose();
}
